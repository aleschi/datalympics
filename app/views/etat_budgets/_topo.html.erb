

<% if !@etat_budget_actuel.nil? %>
<div class="SD-topo-box">
  <div class="SD-topo-box-title">
    <span>Budget de l'état</span>
  </div><br><br>
  <div class="budget-topo_chart-box"> 
    <div class="budget-topo-chart">
      <div class="budget-topo-infos">
        <div class="budget-topo-actuel">
          Budget total actuel dépensé <br>
          <%=  number_with_delimiter(@etat_depenses.sum('cp_conso').to_i, :delimiter => ' ') %>€
        </div>
        <div class="budget-topo-prevu">
          Budget total prévu <br>
          <%=  number_with_delimiter(@etat_budget_actuel.budget_total.to_i, :delimiter => ' ') %>€
        </div>
      </div>
      <div>
       <%= bar_chart [ {name: "Total prévu", data: [["Total",@etat_budget_actuel.budget_total.to_i]]}, {name: "Total actuel", data: [["Total", @etat_depenses.sum('cp_conso').to_i]]} ], library: {
      chart: {
          backgroundColor: '#fff',
         inverted: true,
      
     
      type: 'bar', 
          style:{
          fontFamily: "Spectral",
          maxWidth: "600px",
          }
        },
      colors: ["#8F8F8F", "#48AF5C"],
   yAxis: {
        gridLineColor: '#fff', 
     title: {
       text: "% atteint du budget total prévu"
       }
       },

       plotOptions: {
          bar: {
             pointWidth: 10,
            stacking: 'percent',
             label: { 
              enable: false,
               },
            },
         },
       
       
      } %> 
      </div>
    </div>
    <div class="budget-topo-chart">
      <div class="budget-topo-chart-ecart">
        <div class="budget-topo-chart-ecart-text">
          Ecart budget total à date <br>(= budget prévu a date - budget actuel)
        </div>
        <div class="budget-topo-chart-ecart-box">
          <% if @etat_depenses.sum('cp_prevu').to_i - @etat_depenses.sum('cp_conso').to_i >=  0 %>
            <div class='box-green'>
              - <%= (((@etat_depenses.sum('cp_prevu') - @etat_depenses.sum('cp_conso')) / @etat_depenses.sum('cp_prevu'))*100).round(1) %>%<br>
              <span>- <%= number_with_delimiter((@etat_depenses.sum('cp_prevu').to_i - @etat_depenses.sum('cp_conso').to_i), :delimiter => ' ') %>€</span>
            </div> 
          <% else %>
          <div class='box-red'>
            + <%= (((@etat_depenses.sum('cp_conso') - @etat_depenses.sum('cp_prevu')) / @etat_depenses.sum('cp_prevu'))*100).round(1) %>%<br> 
            <span> + <%= number_with_delimiter((@etat_depenses.sum('cp_conso').to_i - @etat_depenses.sum('cp_prevu').to_i), :delimiter => ' ') %>€</span>
          </div>
          <% end %>
        </div>
      </div>
    </div>
  </div>
  <br><br>
</div>
<div class="SD-topo-box">
  <div class="SD-topo-box-title">
    <span>Répartition des dépenses état</span>
  </div>
  <div class="SD-topo_chart-box">
    <div class="topo-chart">
     
   
      <div>
    
      <%= pie_chart({"SOLIDEO" => @etat_budget_actuel.budget_solideo.to_i, "COJO" => @etat_budget_actuel.budget_cojo.to_i, "Héritage" => @etat_budget_actuel.budget_heritage.to_i, "Haute Performance" => @etat_budget_actuel.budget_hauteperformance.to_i}, library: {
      chart: {
           backgroundColor: '#fff',
        
           style:{
          fontFamily: "Spectral",
          maxWidth: "500px",
          }
        },
   title: {
          text:'<em>Dépenses Totales Prévisionnelles (2016)</em>',
     
          style: {
                  color: "#8F8F8F",
                  fontWeight: "400",
                  },
        },

        tooltip: {
          useHTML: true,
          pointFormat: 'Montant : <b>{point.y:,.0f}€</b><br>',
          shared: true,  
        },

        plotOptions: {
            pie: {
                allowPointSelect: true,
               # cursor: 'pointer',
                dataLabels: {
                    enabled: true,
                    format: '<em>{point.name}<br>{point.y:,.0f}€ - {point.percentage:.1f} %</em>',
                    style: {
                      color: "#8F8F8F",
                      fontSize: "12px",
                      fontWeight: "400",

                      }
                }
            }
        },
      }) %>    
      </div>

  </div>
    
    <% if !@etat_depenses.nil?%>
      <div id="SD-topo-repartition">

        <%= column_chart [ {name: "Budget Etat prévu", data: [["SOLIDEO",@etat_budget_actuel.budget_solideo.to_i],["COJO",@etat_budget_actuel.budget_cojo.to_i],["Héritage", @etat_budget_actuel.budget_heritage.to_i],["Haute Performance",@etat_budget_actuel.budget_hauteperformance.to_i]]},{name: "Budget Etat dépensé", data: [["SOLIDEO",@etat_depenses_solideo.to_i],["COJO",@etat_depenses_cojo.to_i],["Héritage", @etat_depenses_heritage.to_i],["Haute Performance",@etat_depenses_hauteperformance.to_i]]} ], library: {
        chart:{
            type: 'column',
            backgroundColor: '#fff',
         
            style:{
            fontFamily: "Spectral",
               maxWidth: "500px",
            },
            },

        title: {
          text:'<em>Ratio du budget dépensé à date par rapport au budget total prévu </em>',
          margin:40,
          style: {
                  color: "#8F8F8F",
                  fontWeight: "400",
                  },
        },
        colors: ["#8F8F8F", "#48AF5C"],
        plotOptions: {
          column: {
            stacking: 'percent',
           label: { 
              enable: true,
            format: '<em>{point.value}</em>',
            style: {
                   color: "#8F8F8F",
                   fontSize: "12px",
                   fontWeight: "400",
                  },
              },
             tooltip: {
             headerFormat: '<span style="font-size: 10px">{point.key}</span><br/>',
              pointFormat: '<span style="color:{point.color}">●</span> {series.name}: <b>{point.y:,.0f}€ </b><br/>',
              valueSuffix: '€',
            },
        
           },
          },
      legend: {
          reversed: true
        },
      xAxis: {
      reversed: false,
      },
      yAxis: {
          gridLineColor: '#E6F0FF', 
         },
  
          }
      %>
      </div>
    <% end %>      

  </div>
  

</div>
<% end %>

