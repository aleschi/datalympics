

<% if !@etat_budget_actuel.nil? %>
<div class="SD-topo-box">
  <div class="SD-topo-box-title">
    <span>Le Budget de l'état  en chiffres</span>
  </div><br><br>
  
    <div class="calendar-infos">
    <div class="calendar-infos-box">
      <div>
        <i class="fas fa-coins"></i>
      </div>
      <div>
        <%= number_with_delimiter(EtatBudget.last.budget_total.to_i, :delimiter => ' ') %> €<br>
        <span>Budget Total</span>
      </div>
    </div>
    <div class="calendar-infos-box">
      <div>
      <i class="fas fa-hard-hat"></i>
      </div>
      <div>
      <%= @ouvrages.length %><br>
      <span>ouvrages MOA</span>
      </div>
    </div>
    <div class="calendar-infos-box">
      <div>
      <i class="fas fa-chart-pie"></i>
      </div>
      <div>
      25%<br>
        <span>Du budget des JOP2024</span>
      </div>
    </div>

  </div><br><br>
  <div class="calendar-infos">
    <div class="calendar-infos-box">
      <div>
         <i class="fas fa-euro-sign"></i>
      </div>
      <div>
        <%= number_with_delimiter(EtatDepense.all.sum('cp_conso').to_i, :delimiter => ' ') %> €<br>
        <span>Dépenses actuelles</span>
      </div>
    </div>
    <div class="calendar-infos-box">
      <div>
      <i class="fas fa-building"></i>
      </div>
      <div>
      <%= @ouvrages_etat.length %><br>
        <span>Ouvrages financés</span>
      </div>
    </div>
    <div class="calendar-infos-box">
      <div>
     <i class="fas fa-funnel-dollar"></i>
      </div>
      <div>
      <%= ((SolideoFinancement.where('financeur=?','Etat').sum('montant_prevu')/SolideoFinancement.all.sum('montant_prevu')).round(2)*100).round%>%<br>
      <span>Du budget de la Solideo </span>
      </div>
    </div>
    

  </div>
  <br><br>
</div>
<div class="SD-topo-box">
  
  <div class="row">
    <div class="col-md-6">
       <div class="SD-topo-box-title">
    <span>Répartition du budget état</span>
  </div><br>
      <div id="container-pie">
       
      </div>

  </div>
    <div class="col-md-6">  
      <div class="etat-ouvrages-box">

    <div class="SD-topo-box-title">
    <span>Ouvrages financés par l'Etat</span>
  </div><br>
       <div class="SF-topo-financeurs-box">
      <div class="collectivites-ouvrages-name"></div>
      <div class="SF-topo-financeurs-budget"><div class="SF-topo-financeurs-budget-prevu"><em>Fin. prévus €</em></div><div class="SF-topo-financeurs-budget-actuel"> | <em>Evolution</em></div></div>
    </div> <br><br>
         <div class='ouvrages-mo'>
         MOA : ETAT
       </div>
    <% @ouvrages.each do |ouvrage| %>
     
    <div class="SF-topo-financeurs-box">
      <div class="collectivites-ouvrages-name"><%= link_to ouvrage_path(ouvrage) do %><%= Ouvrage.find(ouvrage.id).name %> <% end %></div>
      <div class="SF-topo-financeurs-budget"><div class="SF-topo-financeurs-budget-prevu"><%= number_with_delimiter(OuvragesFinancement.where('name = ? AND ouvrage_id = ?','Etat', ouvrage.id).sum('montant_prevu').to_i, :delimiter => ' ')%> €</div><div class="SF-topo-financeurs-budget-actuel"> |  <i class="fas fa-chart-line"></i> +4%</div></div>
    </div>
    <% end %><br><br>
       <div class='ouvrages-mo'>
         Autres ouvrages financés 
       </div>
      <% @ouvrages_etat.each do |ouvrage| %>
       <div class="SF-topo-financeurs-box">
      <div class="collectivites-ouvrages-name"><%= link_to ouvrage_path(ouvrage) do %><%= Ouvrage.find(ouvrage).name %> <% end %></div>
      <div class="SF-topo-financeurs-budget"><div class="SF-topo-financeurs-budget-prevu"><%= number_with_delimiter(OuvragesFinancement.where('name = ? AND ouvrage_id = ?','Etat', ouvrage).sum('montant_prevu').to_i, :delimiter => ' ')%> €</div><div class="SF-topo-financeurs-budget-actuel"> |  <i class="fas fa-chart-line"></i> +4%</div></div>
    </div>
      <% end %>
    </div>           
      </div>

  </div>
  

</div>
<% end %>

<script>
  $('.infos-details').hide();
  $('.info').mouseover(function() {
    $('.infos-details').show();
    })
  $('.info').mouseout(function() {
    $('.infos-details').hide();
    })

</script>

<script>
Highcharts.chart('container-column2', {
  chart:{
            type: 'column',
            backgroundColor: '#fff',  
            style:{
            fontFamily: "Spectral",  
              maxWidth: '500px',
            },
            
       
          },

     title: {
          text:'Budget dépensé à date par rapport au budget 2025 prévu',
          margin:40,
          style: {
                  color: "#8F8F8F",
                  fontWeight: "400",
                  fontStyle: 'italic',
                  fontSize: '16px',
                  },
        },
  colors: ["#8f8f8f", '#48AF5C'],
    yAxis: {
      gridLineColor: '#fff', 
        title: {
            text: 'Total €'
        }
    },
  tooltip: {
      //  pointFormat: '{series.name}: <b>{point.y}</b><br/>',
        valueSuffix: '€',
        xDateFormat: '%Y',
    },
  xAxis:{
   categories: ["Solideo", "COJO", "Héritage","Haute Perfomance" ],
  },
    plotOptions: {
        series: {
            label: {
                connectorAllowed: false
            },
       
        },
      column: {
           pointWidth: 15,
           tooltip: {        
              backgroundColor: "#fff",        
              style: {
                  fontSize: '12px',     
              },    
             },
           },
         
    },

  

    series: [{
        name: 'Budget prévu',
        data: [<%= @etat_budget_actuel.budget_solideo.to_i %>,<%=@etat_budget_actuel.budget_cojo.to_i%>, <%= @etat_budget_actuel.budget_heritage.to_i%>, <%= @etat_budget_actuel.budget_hauteperformance.to_i %>],
    }, {
        name: 'Budget accordé',
        data: [<%= @etat_depenses_solideo.to_i %>,<%=@etat_depenses_cojo.to_i%>, <%= @etat_depenses_heritage.to_i%>, <%= @etat_depenses_hauteperformance.to_i %>],
    }],

    responsive: {
        rules: [{
            condition: {
                maxWidth: 500
            },
            chartOptions: {
                legend: {
                    layout: 'horizontal',
                    align: 'center',
                    verticalAlign: 'bottom'
                }
            }
        }]
    }

});
</script>
<script>
Highcharts.chart('container-pie', {
    chart: {
        plotBackgroundColor: null,
        plotBorderWidth: null,
        plotShadow: false,
        type: 'pie',
        backgroundColor: '#fff',
          style:{
          fontFamily: "Spectral",
          maxWidth: "500px",
          }
    },
    title: {
         text:'Répartition du budget (prev 2018)',   
          style: {
                  color: "#8F8F8F",
                  fontWeight: "400",
                  fontStyle: "italic",
                  fontSize: '16px',
                  },
    },
  colors: ['#22e37b','#2e5d63', '#628859','#4a6a75'],
    tooltip: {
        pointFormat: '{series.name}: <b>{point.y:,.0f}€ </b>'
    },
    accessibility: {
        point: {
            valueSuffix: '%'
        }
    },
    plotOptions: {
        pie: {
            allowPointSelect: true,
            cursor: 'pointer',
           minSize: 200,
            dataLabels: {
                enabled: true,
                format: '<b>{point.name}</b><br>{point.y:,.0f}€ - {point.percentage:.1f} %',
              style: {
                      color: "#8F8F8F",
                      fontSize: "11px",
                      fontWeight: "400",
                      fontStyle: "italic",
                      },
            }
        }
    },
    series: [{
        name: 'Total',
        colorByPoint: true,
        data: [{
            name: 'Solideo',
            y: <%= @etat_budget_actuel.budget_solideo.to_i%>,
            sliced: true,
            selected: true
        }, {
            name: 'COJO',
            y: <%= @etat_budget_actuel.budget_cojo.to_i%>,
        }, {
            name: 'Heritage',
            y: <%= @etat_budget_actuel.budget_heritage.to_i%>,
        }, {
            name: 'Haute Performance',
            y: <%= @etat_budget_actuel.budget_hauteperformance.to_i%>,
        }]
    }]
});
</script>