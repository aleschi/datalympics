
 <div class="SD-topo-box">
  <div class="SD-topo-box-title">
    <span>Suivi du Budget</span>
  </div><br><br>
   
        <div class="ouvrages-risques">
          <i class="fas fa-exclamation-circle"></i> 2 chantiers à risque
        </div>
        <div class="ouvrages-risques-infos">
          <i class="fas fa-exclamation-triangle"></i> Chantier A, dépassement  10%<br>
          <i class="fas fa-exclamation-triangle"></i> Chantier B, dépassement  20% 
        </div>
   <div class="row">
     <div class="col-md-6">
        <div id="container-bar1"></div>
     </div>
      <div class="col-md-6">
       <div id="container-bar0"></div>
     </div>
   </div>

    <div id="container-chart">
      
    </div><br>

   <div class="EB-details">
       <a href="#MonCollapse" role="button" data-toggle="collapse" aria-expanded="true" aria-controls="MonCollapse">Détails des dépenses </a>      
    </div><br>
    <section id="MonCollapse" class="collapse">
      <div id="container">
    
      </div><br><br>
      <div class="SD-table-box-left">
        <% if !@ouvrage.ouvrages_financements.nil? %>


            <div class="ED_table">
              <table>
                <thead>
                  <tr>
                    <th scope="col">Dates</th>
                    <th scope="col">Décaissements (effectifs/prévus)</th>
                    <th scope="col" class="border-none">Engagements ?</th>

                  </tr>
                </thead>
                <tbody>
                  <% @ouvrage.ouvrages_depenses.order('date DESC').each do |ouvrage_depense| %>
                  <tr>
                    <th scope="row"><%= ouvrage_depense.date.strftime("%b %Y") %></th>
                    <td><div class="table-row"><div class="table-row-left"><%= number_with_delimiter(ouvrage_depense.montant.to_i, :delimiter => ' ') %>€</div> <div class="table-row-right"> / <%= number_with_delimiter(ouvrage_depense.montant_prevu.to_i, :delimiter => ' ') %> € <% if ouvrage_depense.montant.to_i > ouvrage_depense.montant_prevu.to_i%> <i class="fas fa-exclamation-circle"></i> <%end %> </div></div></td>
                    <td class="border-none"><%= number_with_delimiter(ouvrage_depense.montant_engage.to_i, :delimiter => ' ') %>€</td>


                  </tr>
                  <% end %>
                </tbody>
              </table>
            </div>
          <% else %>
            <div>
              Aucune dépense renseignée
            </div>
          <%end%>



      </div>
  </section>
  </div>

<div class="SD-topo-box">
  <div class="SD-topo-box-title">
    <span>Financements</span>
  </div><br><br>
  <div class="row">
    <div class="col-md-6"> 
      
     <div id='container-pie'>
    <%= pie_chart OuvragesFinancement.where('ouvrage_id = ?', @ouvrage.id).unscope(:order).group(:name).sum(:montant_prevu) ,  library: {
     chart: {
       backgroundColor: '#fff',
        type: 'pie',

       style:{
          fontFamily: "Spectral",
          },
    },

      title: {
        text:'2018',
      
        style: {
          color: '#8F8F8F',
          fontSize: '16px',
          fontStyle: 'italic',
          }
      },
       colors: ["#8993F5","#89E5DC","#8BC8FD","#9CFF90", "#FFB458","#FF678F","#3B3B3F", "#FDEB6B", "#37A09E","#F54E53","#89C7FD"],
     plotOptions: {
        pie: {
           size: 100,
           dataLabels: {
                    enabled: true,
                    format: '<em>{point.name}<br>{point.y:,.0f} €</em>',
                   
                    
                    style: {
                      color: "#8F8F8F",
                      fontSize: "11px",
                      fontWeight: "400",

                      }
                },
        }
    },
  }
   
    %>
      
    </div>
    </div>
    <div class="col-md-6"> 
      
     <div id='container-pie'>
    <%= pie_chart OuvragesFinancement.where('ouvrage_id = ?', @ouvrage.id).unscope(:order).group(:name).sum(:montant_prevu) ,  library: {
     chart: {
       backgroundColor: '#fff',
       plotBackgroundColor: nil,
        plotBorderWidth: nil,
        plotShadow: false,
        type: 'pie',

       style:{
          fontFamily: "Spectral",
         maxWidth: '500px',
          },
    },

      title: {
        text:'2020',
      
        style: {
          color: '#8F8F8F',
          fontSize: '16px',
          fontStyle: 'italic',
          }
      },
       colors: ["#8993F5","#89E5DC","#8BC8FD","#9CFF90", "#FFB458","#FF678F","#3B3B3F", "#FDEB6B", "#37A09E","#F54E53","#89C7FD"],
     plotOptions: {
        pie: {
          allowPointSelect: true,
          cursor: 'pointer',
           size: 200,
           dataLabels: {
                    enabled: true,
                    format: '<em>{point.name}<br>{point.y:,.0f} €</em>',
                   
                    
                    style: {
                      color: "#8F8F8F",
                      fontSize: "11px",
                      fontWeight: "400",

                      }
                },
        }
    },
  }
   
    %>
      
    </div>
    </div>
  </div>
</div>

<script>
Highcharts.chart('container', {

   chart:{
            backgroundColor: '#fff',
           type: 'spline',
            spacing: [40,40,40,40],
        style:{
          fontFamily: "Spectral",
         
          },
        scrollablePlotArea: {
            minWidth: 700,
            scrollPositionX: 1
        }
          },

      title: {
        text:"Suivi trimestriel des décaissements",
        margin:40,
        style: {
                  color: "#8F8F8F",
                  fontWeight: "400",
          fontStyle: 'italic',
      fontSize: '16px',
                  },
      },
  colors: ['#487f7f',"#8f8f8f"],
    yAxis: {
      gridLineColor: '#E6F0FF', 
        title: {
            text: 'Total €'
        }
    },
  tooltip: {
      //  pointFormat: '{series.name}: <b>{point.y}</b><br/>',
        valueSuffix: '€',
        xDateFormat: '%b %Y',
    },
  xAxis:{
     type: 'datetime'
   // max: 2025,
  },
    plotOptions: {
        series: {
            label: {
                connectorAllowed: false
            },
            pointStart: Date.UTC(2018,0, 1),
          pointInterval: 24*3600*1000*30*3,
        }
    },

  

    series: [{
        name: 'Dépenses',
        data: <%= @depenses %>,
    }, {
        name: 'Dépenses prévues',
        data: <%= @depenses_prevu %>,
    }],

    responsive: {
        rules: [{
            condition: {
                maxWidth: 500
            },
            chartOptions: {
                legend: {
                    layout: 'horizontal',
                    align: 'center',
                    verticalAlign: 'bottom'
                }
            }
        }]
    }

});
</script>
<script>
Highcharts.chart('container-bar0', {
    chart: {
        type: 'bar',
      style:{
          fontFamily: "Spectral",
         maxWidth: '500px',
          },
      height: "300px",
    },
    title: {
        text: null,
        style: {
                  color: "#8F8F8F",
                  fontWeight: "400",
          fontStyle: 'italic',
      fontSize: '16px',
                  },
    },
  colors: ['#4FC5CE'],
    xAxis: {
        categories:  ["Budget initial", "Budget actuel", "Dépenses à 2020 prév", "Dépenses à 2020" ],
        title: {
            text: null
        }
    },
    yAxis: {
        min: 0,
      gridLineColor: '#fff', 
        title: {
            text: 'Montant (€)',
            align: 'high'
        },
        labels: {
            overflow: 'justify'
        }
    },
    tooltip: {
        valueSuffix: ' €'
    },
  legend: {
    enabled: true,
  },
    plotOptions: {
        bar: {
            dataLabels: {
                enabled: true
            }
        }
    },
    
    credits: {
        enabled: false
    },
    series: [{
        name: 'Chantier A',
      color: "#3233FF",
        data: [{y: <%= @ouvrage.budget.to_i%> , color: "#3233FF"},{y: <%= (@ouvrage.budget*2.5).to_i%> , color: "#3233FF"}, {y: <%= (@ouvrage.budget/3.5).to_i%>, color: "#3233FF"}, {y: <%= (@ouvrage.budget/1.5).to_i%>, color: "#3233FF"}],
     }, {
        name: 'Chantier B',
       color: "#C90200",
        data: [{y: <%= @ouvrage.budget.to_i%> , color: "#C90200"},{y: <%= (@ouvrage.budget*2).to_i%> , color: "#C90200"}, {y: <%= (@ouvrage.budget/3).to_i%>, color: "#C90200"}, {y: <%= (@ouvrage.budget/2).to_i%>, color: "#C90200"}],
     }]
});
  </script>

<script>
Highcharts.chart('container-bar1', {
    chart: {
        type: 'column',
      backgroundColor: '#fff',
          style:{
          fontFamily: "Spectral",
          maxWidth: '500px',
          },
      height: "300px",
    },
    title: {
        text: null,
        style: {
                  color: "#8F8F8F",
                  fontWeight: "400",
          fontStyle: 'italic',
          fontSize: '16px',
                  },
    },

    xAxis: {
        categories: ['Réalisé 2018', 'Réalisé 2019', "Prév 2020 CA 2020", "Prev atterissage 2020", "Prev 2021"],
        crosshair: true
    },
    yAxis: {
        min: 0,
        title: {
            text: 'Budget (€)'
        },
      gridLineColor: "#fff",
    },
  legend: {
    enabled: false,
  },
    tooltip: {
        headerFormat: '<span style="font-size:10px">{point.key}</span><table>',
        pointFormat: '<tr><td style="color:{series.color};padding:0">{series.name}: </td>' +
            '<td style="padding:0"><b>{point.y:.1f} €</b></td></tr>',
        footerFormat: '</table>',
        shared: true,
        useHTML: true
    },
    plotOptions: {
        column: {
            pointPadding: 0.2,
            borderWidth: 0,
          dataLabels: {
                enabled: true
            }
        }
    },
    series: [{
        name: 'Budget',
        data: [{y:37, color:"#3233FF" }, {y:67, color:"#3233FF" }, {y:160, color: "#F9EA43"}, {y:111, color: "#8435FA"}, {y:228, color: "#C90200"}]

    }]
});
 </script> 

<script>
Highcharts.chart('container-chart', {
    chart: {
        type: 'waterfall',
      spacing: [40,40,40,40],
        style:{
          fontFamily: "Spectral",
          },
    },

    title: {
        text: "Evolution de la maquette des dépenses de l'ouvrage ",
      margin:40,
        style: {
                  color: "#8F8F8F",
                  fontWeight: "400",
          fontStyle: 'italic',
      fontSize: '16px',
                  },
    },

    xAxis: {
        type: 'category',
      labels: {
        formatter: function () {
            return '<a href="/chantiers/1">' + this.value + '</a>'
        },
        useHTML: true,
      },
    },

    yAxis: {
      gridLineColor: '#E6F0FF', 
        title: {
            text: 'Montant €'
        }
    },

    legend: {
        enabled: false
    },

    tooltip: {
        pointFormat: '<b>${point.y:,.2f}</b> €'
    },

    series: [{
      borderColor: '#fff',
      data: [{
            name: 'Prévisionnel 2018',
            y: 1386929000,
            color: "#8F8F8F",
        }, {
            name: 'Chantier A ',
            y: 13100000,
            color: "#F1013B",
        }, {
            name: 'Chantier B',
            y: 500000000,
            color: "#F1013B",
        }, {
            name: 'Prévisionnel 2020',
            isSum: true,
            color: Highcharts.getOptions().colors[1]
        }],
        dataLabels: {
            enabled: true,
            formatter: function () {
                return Highcharts.numberFormat(this.y / 1000, 0, ',') + 'k';
            },
            style: {
                fontWeight: 'bold'
            }
        },
        pointPadding: 0
    }]
});
</script>
