
 <section class="SD-topo-box" id="budget_section">
  <div class="SD-topo-box-title">
    <span>Suivi du Budget</span>
  </div><br><br>

  <div class="row">
    <div class="col-md-12">
      <% if @ouvrage.chantiers.where('date = ?',@lastdate).count > 0%>
        <% @ouvrage.chantiers.where('date = ?',@lastdate).each_with_index do |chantier,i| %>
          <div><%= chantier.typecontrat %> - dépenses actées totales = <%= (chantier.total_depenses_actees/1000).to_i%> k€ - dépenses payées : <%= (chantier.cumul_paiements/1000).to_i%> k€</div>
          <div>Dépenses effectuées en 2021 : <%= (chantier.paiements_annee/1000).to_i%> k€ - budget 2021 : <%= (chantier.budget_annee/1000).to_i%> k€</div>
          <div id="programme<%=i%>"></div>
          <script>
  
            Highcharts.stockChart('programme<%=i%>', {
            // mapNavigation: {
            //           enableMouseWheelZoom: true
            //       },
              chart:{
                  backgroundColor: '#fff',
                  borderColor: '#fff',
                  type: 'scatter',
                  height: '300px',
                  style:{
                    fontFamily: "Marianne Regular",
                    // maxWidth: '500px'
                    },
                
                  zoomType: 'x',

                    },
              navigator: {
                  maskFill: 'rgba(248,248,248,0.3)',
              },

              rangeSelector: {

                      buttons: [ {
                          type: 'month',
                          count: 1,
                          text: '1m'
                      }, {
                          type: 'month',
                          count: 3,
                          text: '3m'
                      },{
                          type: 'month',
                          count: 6,
                          text: '6m'
                      }, {
                          type: 'year',
                          count: 1,
                          text: '1an'
                      }, {
                          type: 'all',
                          text: 'Tout'
                      }],
                      selected: 3,
                      buttonTheme: { // styles for the buttons
                      fill: '#F8F8F8',
                      stroke: 'none',
                      'stroke-width': 0,
                      r: 4,
                      style: {
                          color: '#000',
                          fontWeight: 'bold'
                      },
                      states: {
                          hover: {
                          },
                          select: {
                              fill: '#000091',
                              style: {
                                  color: 'white'
                              }
                          }
                          // disabled: { ... }
                      }
                  },
                  inputStyle: {
                          color: '#000',
                        
                      },
                  labelStyle: {
                      color: '#000', 
                  },
                  },
              legend: {
                enabled: true,
                verticalAlign: 'top',
              
              },
            title: {
                    text:"",
            },
         
            yAxis: {
              gridLineColor: '#fff', 
                title: {
                    text: 'Total k€'
                }
            },
            scrollbar: {
              barBackgroundColor: '#CECECE',
              barBorderColor: "#F8F8F8",
              barBorderRadius: 6,
              buttonBackgroundColor: "#F8F8F8",
              buttonArrowColor:'#CECECE',
              buttonBackgroundColor:"#F8F8F8",
              buttonBorderColor:"#F8F8F8",
              buttonBorderRadius: 6,
              rifleColor:"#F8F8F8",
            },
            tooltip: {
              borderColor: 'transparent',
              borderRadius: 16,
              backgroundColor: '#fff',
              },
            xAxis:{
              type: 'datetime',
            //  tickInterval: 30 * 24 * 3600 * 1000,
            // tickPixelInterval:200,
            },
            yAxis: {
              plotLines: [{
                color: '#FF6F4C',
                label: {
                  text: "Prev fin d'année",
                  textAlign: 'left',
                  verticalAlign: 'middle',
                  
                  x: -30,
                  style: {
                    color:'#FF6F4C',
                  },
                },
                zIndex: 1,
                width: 2,
                value: <%= chantier.total_depenses_actees.to_i/1000%>,
              }],
            },
            plotOptions: {
                series: {
                  lineWidth: 2,
                    label: {
                        connectorAllowed: false
                    }, 
                    marker: {
                        enabled: true,
                        radius:2,
                    },
                  step: 'left',
                }
            },
 
  
            series: [
              {
                name: 'Demandes de paiements payées',
                color: '#2E5D63',
                data: [   
                  <% @ouvrage.chantiers.where('typecontrat = ?',chantier.typecontrat).each do |depense|%>     
                    {name:  'Dépenses payées', x: Date.UTC(<%=depense.date.year%>,<%= depense.date.month-1%>, <%=depense.date.day%>),y: <%=  (depense.cumul_paiements.to_f/1000).round%>,  },
                  <% end %>
                ],
                tooltip: {
                   pointFormatter: function() {
                var point = this,
                series = point.series,
                firstDate = Highcharts.dateFormat('%e %b %Y', point.x),
                number = Highcharts.numberFormat(point.y, -1, ',',' '),
                header = '<span style="font-size: 12px">' + firstDate   + '</span><br/>',
                 
                content =   '<b>Dépense payées: '+ number + ' k€</b><br/>';

                return header + content;
                },
                },
            
              },
              
              {
                name: 'Dépenses actées à date',
                color: '#8F8F8F',
                data: [
                  <% @ouvrage.chantiers.where('typecontrat = ?',chantier.typecontrat).each do |depense|%>  
                    {name:  'Dépenses actées à date', x: Date.UTC(<%=depense.date.year%>,<%= depense.date.month-1%>, <%=depense.date.day%>),y: <%=  (depense.cumul_depenses_actees.to_f/1000).round%>,  },
                  <% end %>
                ],
              tooltip: {
                   pointFormatter: function() {
                var point = this,
                series = point.series,
                firstDate = Highcharts.dateFormat('%e %b %Y', point.x),
                number = Highcharts.numberFormat(point.y, -1, ',',' '),
                header = '<span style="font-size: 12px">' + firstDate   + '</span><br/>',
                 
                content =   '<b>Dépenses actées à date: '+ number + ' k€</b><br/>';

                return header + content;
              },
              },
            
            },
 
  
      
            ],

            responsive: {
                rules: [{
                    condition: {
                        maxWidth: 500
                    },
                    chartOptions: {
                        legend: {
                            layout: 'horizontal',
                            align: 'center',
                            verticalAlign: 'bottom'
                        }
                    }
                }]
            }

            });
          </script>
        <% end %>
      <%end %>
    
     </div>

   </div>

  <br><br>
 
   <div class="SD-topo-box-title">
        <span>Infos sur le suivi budgétaire</span>
   </div><br><br>
   
   <div class="flexslider" id="flexslider2">
        <ul class="slides">
          <% if @ouvrage.ouvrages_revues.count > 0 %>
          <% @ouvrage.ouvrages_revues.order('date DESC').each do |revue| %>
          <li>  
            <div class="flexslider-slide">
              <div class="ouvrages-flexslider-title">
                   Rapport de supervision <%= l(revue.date, :format => '%B %Y')%> : 
                </div><br>
            <div class="row">
              <div class="col-md-6">               
                
                 <div class="jauge-box">
                <div class="jauge-risques">
                  <% if revue.budget_indicateur == 1%><div class="risque1 risque-active"></div><% else %><div class="risque1"></div><% end %>
                  <% if revue.budget_indicateur == 2 %><div class="risque2 risque-active"></div><% else %><div class="risque2"></div><% end %>
                  <% if revue.budget_indicateur == 3%><div class="risque3 risque-active"></div><% else %><div class="risque3"></div><% end %>
                  <% if revue.budget_indicateur == 4%><div class="risque4 risque-active"></div><% else %><div class="risque4"></div><% end %>
                  <% if revue.budget_indicateur == 5%><div class="risque5 risque-active"></div><% else %><div class="risque5"></div><% end %>
                  
                </div>
                     <div class="jauge-infos">
                    <% if @ouvrage.ouvrages_financements.count > 0 %>
                      <%= number_with_delimiter((@ouvrage.ouvrages_financements.order("date DESC").first.montant_prevu-@ouvrage.budget).to_i, :delimiter => ' ')%><% else %> 0<% end %>  € <br>
                    <span>Surcoûts envisagés </span>
                  </div>
                </div>
                <br><br>
                  <div class="ouvrages-flexslider-text">
                    <span>
                    <em>Revue MOA</em> 
                    </span> <br><br>
                    <%= revue.budget_commentaire %>
                </div>
              </div>
              <div class="col-md-6">
                <div class="ouvrages-flexslider-text">
                  <span><em>Actions prises par la Solideo </em></span><br><br>
                  <%= revue.budget_action %>
                </div><br>
              </div>
            </div>
            </div>
          </li>
          <% end %>
          <% end %>
        </ul>
      </div>
   
   <br><br>

</section>


<div class="SD-topo-box">
  <div class="SD-topo-box-title">
    <span>Financements</span>
  </div><br><br>
  <div class="row">
    <div class="col-md-12"> 
      Données ?
    </div>
  </div>
</div>



<script>
 $(document).on("turbolinks:load", function() {
  $('#flexslider2').flexslider({ 
    animation: "slide",
    animationLoop: false,
    slideshow: false, 
    prevText: "Précédent",    
    nextText:'Suivant',
  });
});
</script>
