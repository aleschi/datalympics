
 <section class="SD-topo-box" id="budget_section">
  <div class="SD-topo-box-title">
    <span>Suivi du Budget</span>
  </div><br><br>
  <div class="flexslider2" id="flexslider">
    <ul class="slides">
      <% @dates_ouvrages_reporting.each_with_index do |date,i|%>
      <% if @ouvrage.chantiers.where('date = ?',date).count > 0 %>
        <li> 
          <div class="budget-ouvrages-mois">
            <div class="box-convention-date"><%= l(date, format: "%e %B %Y") %> </div>
            <div>
              <div class="inline-flex"> 
              <% @ouvrage.chantiers.where('date = ?',date).each_with_index do |chantier,j| %>
              <% if !chantier.nil?%>
                <div>
                  <div class="box-convention-date"><%= chantier.typecontrat %> </div>
                  <div id="ouvrages<%=i%><%=j%>"></div>
                    <script>
                    Highcharts.chart('ouvrages<%=i%><%=j%>', {
                      chart: {
                          type: 'column',
                          <% if @ouvrage.chantiers.where('date = ?',date).count == 1%>
                          width: 750,
                          <%elsif @ouvrage.chantiers.where('date = ?',date).count == 2%>
                          width: 350,
                          <% else %>
                          width: 350,
                          <% end %>
                        backgroundColor: '#fff',
                            style:{
                            fontFamily: "Marianne Regular",
                       
                            },
                      },
                      title: {
                          text: null,
                          style: {
                                    color: "#8F8F8F",
                                    fontWeight: "400",
                            fontStyle: 'italic',
                            fontSize: '16px',
                                    },
                      },

                      xAxis: {
                          categories: ["Dépenses 2021", "Budget 2021", "Dépenses totales", "Dépenses actées totales"],
                          crosshair: true
                      },
                      yAxis: {
                          min: 0,
                          title: {
                              text: 'Budget dépensé (k€)'
                          },
                        gridLineColor: "#fff",
                      },
                      legend: {
                        enabled: false,
                      },
                      tooltip: {
                          headerFormat: '<span style="font-size:10px">{point.key}</span><br>',
                          pointFormat: '<span style="padding:0"><b> {point.y:.1f} k€</b></span>',
                
                          shared: true,
                          useHTML: true,
                          borderColor: 'transparent',
                          borderRadius: 16,
                          backgroundColor: '#fff',
                        },
                      plotOptions: {
                          column: {
                              pointPadding: 0.2,
                              borderWidth: 0,
                              grouping: false,
                            
                          }
                      },
                      series: [{
                          name: 'Dépenses',
                          data: [
                            {y:<%= (chantier.paiements_annee/1000).round(1)%>, color:"#2E5D63", dataLabels: {
                                    enabled: true,
                                    formatter: function() {

                                      var point = this;                      
                                      ecart = <%= ((chantier.paiements_annee-Chantier.where('name=? AND typecontrat = ? AND date = ?',chantier.name, chantier.typecontrat,date-1.month).sum('paiements_annee'))/1000).round(1)%>;
                                      
                                      number = Highcharts.numberFormat(point.y, -1, ',',' ');
                                      if (ecart > 0){
                                        header = '<span style="font-size: 10px;color:#20E37B"> +' + ecart  + '</span><br/>';
                                      }else{
                                        header = '';
                                      }
                                        content = '<b>' + number  + ' </b>';

                                      return header + content;
                                    },
                                },},
                            
                            {y:<%= (chantier.budget_annee/1000).round(1)%>, color:"#bfbfbf", dataLabels: {
                                    enabled: true,
                                    formatter: function() {

                                      var point = this;                      
                                      ecart = <%= ((chantier.budget_annee-Chantier.where('name=? AND typecontrat = ? AND date = ?',chantier.name, chantier.typecontrat,date-1.month).sum('budget_annee'))/1000).round(1)%>;
                                      
                                      number = Highcharts.numberFormat(point.y, -1, ',',' ');
                                      if (ecart > 0){
                                        header = '<span style="font-size: 10px;color:#20E37B"> +' + ecart  + '</span><br/>';
                                      }else{
                                        header = '';
                                      }
                                        content = '<b>' + number  + ' </b>';

                                      return header + content;
                                    },
                                },},

                              {y:<%= (chantier.cumul_paiements/1000).round(1)%>, color:"#2E5D63", dataLabels: {
                                    enabled: true,
                                    formatter: function() {

                                      var point = this;                      
                                      ecart = <%= ((chantier.cumul_paiements-Chantier.where('name=? AND typecontrat = ? AND date = ?',chantier.name, chantier.typecontrat,date-1.month).sum('cumul_paiements'))/1000).round(1)%>;
                                      
                                      number = Highcharts.numberFormat(point.y, -1, ',',' ');
                                      if (ecart > 0){
                                        header = '<span style="font-size: 10px;color:#20E37B"> +' + ecart  + '</span><br/>';
                                      }else{
                                        header = '';
                                      }
                                        content = '<b>' + number  + ' </b>';

                                      return header + content;
                                    },
                                },},

                                {y:<%= (chantier.total_depenses_actees/1000).round(1)%>, color:"#7D4E5B", dataLabels: {
                                    enabled: true,
                                    formatter: function() {

                                      var point = this;                      
                                      ecart = <%= ((chantier.total_depenses_actees-Chantier.where('name=? AND typecontrat = ? AND date = ?',chantier.name, chantier.typecontrat,date-1.month).sum('total_depenses_actees'))/1000).round(1)%>;
                                      
                                      number = Highcharts.numberFormat(point.y, -1, ',',' ');
                                      if (ecart > 0){
                                        header = '<span style="font-size: 10px;color:#20E37B"> +' + ecart  + '</span><br/>';
                                      }else{
                                        header = '';
                                      }
                                        content = '<b>' + number  + ' </b>';

                                      return header + content;
                                    },
                                },},
                          
                            ],
                          pointPlacement: 0,
                      }]
                    });
                    </script> 
                </div>
              <% end %>
              <% end %>
              </div>
            </div>
          </div>
        </li>
      <% end %>
      <% end %>
    </ul>
  </div>
<br><br>
 
   <div class="SD-topo-box-title">
        <span>Infos sur le suivi budgétaire</span>
   </div><br><br>
   
   <div class="flexslider" id="flexslider2">
        <ul class="slides">
          <% if @ouvrage.ouvrages_revues.count > 0 %>
          <% @ouvrage.ouvrages_revues.order('date DESC').each do |revue| %>
          <li>  
            <div class="flexslider-slide">
              <div class="ouvrages-flexslider-title">
                   Rapport de supervision <%= l(revue.date, :format => '%B %Y')%> : 
                </div><br>
            <div class="row">
              <div class="col-md-6">               
                
                 <div class="jauge-box">
                <div class="jauge-risques">
                  <% if revue.budget_indicateur == 1%><div class="risque1 risque-active"></div><% else %><div class="risque1"></div><% end %>
                  <% if revue.budget_indicateur == 2 %><div class="risque2 risque-active"></div><% else %><div class="risque2"></div><% end %>
                  <% if revue.budget_indicateur == 3%><div class="risque3 risque-active"></div><% else %><div class="risque3"></div><% end %>
                  <% if revue.budget_indicateur == 4%><div class="risque4 risque-active"></div><% else %><div class="risque4"></div><% end %>
                  <% if revue.budget_indicateur == 5%><div class="risque5 risque-active"></div><% else %><div class="risque5"></div><% end %>
                  
                </div>
                     <div class="jauge-infos">
                    <% if @ouvrage.ouvrages_financements.count > 0 %>
                      <%= number_with_delimiter((@ouvrage.ouvrages_financements.order("date DESC").first.montant_prevu-@ouvrage.budget).to_i, :delimiter => ' ')%><% else %> 0<% end %>  € <br>
                    <span>Surcoûts envisagés </span>
                  </div>
                </div>
                <br><br>
                  <div class="ouvrages-flexslider-text">
                    <span>
                    <em>Revue MOA</em> 
                    </span> <br><br>
                    <%= revue.budget_commentaire %>
                </div>
              </div>
              <div class="col-md-6">
                <div class="ouvrages-flexslider-text">
                  <span><em>Actions prises par la Solideo </em></span><br><br>
                  <%= revue.budget_action %>
                </div><br>
              </div>
            </div>
            </div>
          </li>
          <% end %>
          <% end %>
        </ul>
      </div>
   
   <br><br>

</section>


<div class="SD-topo-box">
  <div class="SD-topo-box-title">
    <span>Financements</span>
  </div><br><br>
  <div class="row">
    <div class="col-md-12"> 
      Données ?
    </div>
  </div>
</div>



<script>
 $(document).on("turbolinks:load", function() {
  $('#flexslider2').flexslider({ 
    animation: "slide",
    animationLoop: false,
    slideshow: false, 
    prevText: "Précédent",    
    nextText:'Suivant',
  });
});
</script>
