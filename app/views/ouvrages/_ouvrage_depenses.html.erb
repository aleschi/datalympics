
 <div class="SD-topo-box">
  <div class="SD-topo-box-title">
    <span>Suivi du Budget</span>
  </div><br><br>
  <% if @ouvrage.ouvrages_financements.count > 0 %>
    <div class="ouvrages-risques-infos">          
          <% if (@ouvrage.ouvrages_financements.order("date DESC").first.montant_prevu-@ouvrage.budget).to_i > 0 %>
          <i class="fas fa-exclamation-triangle"></i> Surcoûts : <%= number_with_delimiter((@ouvrage.ouvrages_financements.order("date DESC").first.montant_prevu-@ouvrage.budget).to_i, :delimiter => ' ')%> €<br>
          <% elsif (@ouvrage.ouvrages_financements.order("date DESC").first.montant_prevu-@ouvrage.budget).to_i < 0 %>
          Baisse des coûts : <%= number_with_delimiter((@ouvrage.ouvrages_financements.order("date DESC").first.montant_prevu-@ouvrage.budget).to_i, :delimiter => ' ')%> € <br>
          <% else %>
          Pas de surcoûts envisagés
          <% end %>         
   </div>
  <% end %> <br><br>
  <div class="row">
     <div class="col-md-6">
        <div id="container-bar0"></div>
     </div>
      <div class="col-md-6">
       <div id="container-bar1"></div>
     </div>
   </div>
  <div class="ouvrages-risques-infos">
      Données prévisionnelles manquantes 
  </div>
  <br><br>
 
   <div class="SD-topo-box-title">
        <span>Infos sur le suivi budgétaire</span>
   </div><br><br>
   
   <div class="flexslider" id="flexslider2">
        <ul class="slides">
          <% if @ouvrage.ouvrages_revues.count > 0 %>
          <% @ouvrage.ouvrages_revues.order('date DESC').each do |revue| %>
          <li>  
            <div class="row">
              <div class="col-md-6">               
                <div class="ouvrages-flexslider-text">
                   <em><%= l(revue.date, :format => '%B %Y')%>: </em>
                </div><br>
                <div class="jauge-risques">
                  <% if revue.budget_indicateur == 1%><div class="risque1 risque-active"></div><% else %><div class="risque1"></div><% end %>
                  <% if revue.budget_indicateur == 2 %><div class="risque2 risque-active"></div><% else %><div class="risque2"></div><% end %>
                  <% if revue.budget_indicateur == 3%><div class="risque3 risque-active"></div><% else %><div class="risque3"></div><% end %>
                  <% if revue.budget_indicateur == 4%><div class="risque4 risque-active"></div><% else %><div class="risque4"></div><% end %>
                  <% if revue.budget_indicateur == 5%><div class="risque5 risque-active"></div><% else %><div class="risque5"></div><% end %>
                  
                </div>
                  <div class="ouvrages-flexslider-text">
                    <span>
                    Surcoûts envisagés :  mensuel? € <br>
                    </span> <br><br>
                    <%= revue.budget_commentaire %>
                </div>
              </div>
              <div class="col-md-6">
                <div class="ouvrages-flexslider-text">
                  <span><em>Actions envisagées </em></span><br><br>
                  <%= revue.budget_action %>
                </div><br>
              </div>
            </div>
          </li>
          <% end %>
          <% end %>
        </ul>
      </div>
   
   <br><br>

</div>

<% if !@ouvrage.ouvrages_financements.nil? && @ouvrage.ouvrages_financements.count > 0 %>
<div class="SD-topo-box">
  <div class="SD-topo-box-title">
    <span>Financements</span>
  </div><br><br>
  <div class="row">
    <div class="col-md-6">      
     <div id='container-pie'>
    <%= pie_chart OuvragesFinancement.where('ouvrage_id = ? AND date = ?', @ouvrage.id, @ouvrage.ouvrages_financements.first.date ).unscope(:order).group(:name).sum(:montant) ,  library: {
     chart: {
       backgroundColor: '#fff',
        type: 'pie',

       style:{
          fontFamily: "Spectral",
          },
    },

      title: {
        text:'2018',
      
        style: {
          color: '#8F8F8F',
          fontSize: '16px',
          fontStyle: 'italic',
          }
      },
       colors: ["#2E5D63","#C68D7B","#20E37B","#5770BE", "#76505B","#FF678F","#3B3B3F", "#FDEB6B", "#37A09E","#F54E53","#89C7FD"],
     plotOptions: {
        pie: {
           size: 100,
           dataLabels: {
                    enabled: true,
                    format: '<em>{point.name}<br>{point.y:,.0f} €</em>',
                   
                    
                    style: {
                      color: "#8F8F8F",
                      fontSize: "11px",
                      fontWeight: "400",

                      }
                },
        }
    },
  }
   
    %>
      
    </div>
    </div>
    <div class="col-md-6"> 
      
     <div id='container-pie'>
    <%= pie_chart OuvragesFinancement.where('ouvrage_id = ? AND date = ? ', @ouvrage.id, @ouvrage.ouvrages_financements.last.date).unscope(:order).group(:name).sum(:montant) ,  library: {
     chart: {
       backgroundColor: '#fff',
       plotBackgroundColor: nil,
        plotBorderWidth: nil,
        plotShadow: false,
        type: 'pie',

       style:{
          fontFamily: "Spectral",
         maxWidth: '500px',
          },
    },

      title: {
        text:'2020',
      
        style: {
          color: '#8F8F8F',
          fontSize: '16px',
          fontStyle: 'italic',
          }
      },
        colors: ["#2E5D63","#C68D7B","#20E37B","#5770BE", "#76505B","#FF678F","#3B3B3F", "#FDEB6B", "#37A09E","#F54E53","#89C7FD"],
    plotOptions: {
        pie: {
          allowPointSelect: true,
          cursor: 'pointer',
           size: 200,
           dataLabels: {
                    enabled: true,
                    format: '<em>{point.name}<br>{point.y:,.0f} €</em>',
                   
                    
                    style: {
                      color: "#8F8F8F",
                      fontSize: "11px",
                      fontWeight: "400",

                      }
                },
        }
    },
  }
   
    %>
      
    </div>
    </div>
  </div>
</div>
<% end %>

<% if !@ouvrage.ouvrages_financements.nil? && @ouvrage.ouvrages_financements.count > 0 %>
<script>
Highcharts.chart('container-bar0', {
    chart: {
        type: 'bar',
      style:{
          fontFamily: "Spectral",
         maxWidth: '500px',
          },
      height: "300px",
    },
    title: {
        text: null,
        style: {
                  color: "#8F8F8F",
                  fontWeight: "400",
          fontStyle: 'italic',
      fontSize: '16px',
                  },
    },
  colors: ['#2E5D63'],
    xAxis: {
        categories:  ["Budget initial", "Budget recalculé", "Dépenses à 2020 prévues", "Dépenses réalisées" ],
        title: {
            text: null
        }
    },
    yAxis: {
        min: 0,
      gridLineColor: '#fff', 
        title: {
            text: 'Montant (€)',
            align: 'high'
        },
        labels: {
            overflow: 'justify'
        }
    },
    tooltip: {
        valueSuffix: ' €'
    },
  legend: {
    enabled: false,
  },
    plotOptions: {
        bar: {
            dataLabels: {
                enabled: true
            }
        }
    },
    
    credits: {
        enabled: false
    },
    series: [ {
        name: 'Suivi',
       color: "#2E5D63",
        data: [ <%= @ouvrage.budget.to_i%> ,  <%= (@ouvrage.ouvrages_financements.order("date DESC").first.montant_prevu).to_i%> , 0,  <%= @ouvrage.ouvrages_depenses.sum('montant').to_i%>],
     }]
});
  </script>
<% end %>
<script>
Highcharts.chart('container-bar1', {
    chart: {
        type: 'column',
      backgroundColor: '#fff',
          style:{
          fontFamily: "Spectral",
          maxWidth: '500px',
          },
      height: "300px",
    },
    title: {
        text: null,
        style: {
                  color: "#8F8F8F",
                  fontWeight: "400",
          fontStyle: 'italic',
          fontSize: '16px',
                  },
    },

    xAxis: {
        categories: ['Prévu 2018','Réalisé 2018','Prévu 2019', 'Réalisé 2019', "Prév 2020 CA 2020", "Prev atterissage 2020", "Prev 2021"],
        crosshair: true
    },
    yAxis: {
        min: 0,
        title: {
            text: 'Budget (M€)'
        },
      gridLineColor: "#fff",
    },
  legend: {
    enabled: false,
  },
    tooltip: {
        headerFormat: '<span style="font-size:10px">{point.key}</span><table>',
        pointFormat: '<tr><td style="color:{series.color};padding:0">{series.name}: </td>' +
            '<td style="padding:0"><b>{point.y:.1f} M€</b></td></tr>',
        footerFormat: '</table>',
        shared: true,
        useHTML: true
    },
    plotOptions: {
        column: {
            pointPadding: 0.2,
            borderWidth: 0,
          dataLabels: {
                enabled: true
            }
        }
    },
    series: [{
        name: 'Budget',
        data: [{y:0, color:"#bfbfbf" },
               {y: <%= (@ouvrage.ouvrages_depenses.where("date = ?", Date.new(2018,1)).sum('montant')/1000000).round %>, color:"#C68D7B" },
               {y:0, color:"#bfbfbf" },
               {y: <%= (@ouvrage.ouvrages_depenses.where("date = ?", Date.new(2019,1)).sum('montant')/1000000).round %> , color:"#C68D7B" }, 
               {y:0, color: "#2E5D63"}, 
               {y:<%= (@ouvrage.ouvrages_depenses.where("date = ?", Date.new(2020,1)).sum('montant')/1000000).round %>, color: "#20E37B"}, 
               {y:0, color: "#5770BE"}]

    }]
});
 </script> 
<script>
$(window).load(function() {
  $('#flexslider2').flexslider({ 
    animation: "slide",
    animationLoop: false,
    slideshow: false, 
  });
});
</script>